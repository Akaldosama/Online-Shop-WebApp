<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>Online Shop</title>-->
<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">-->
<!--</head>-->
<!--<body>-->
<!--    <nav class="navbar navbar-light mx-5">-->
<!--        <p class="navbar-brand">Akaldo</p>-->
<!--        <ul class="d-flex list-unstyled gap-3">-->
<!--            <li>About us</li>-->
<!--            <li>Contact</li>-->
<!--            <li>Features</li>-->
<!--            <li>Pricing</li>-->
<!--        </ul>-->
<!--    </nav>-->
<!--    <div class="container d-flex gap-3 flex-wrap">-->
<!--        {% for i in items %}-->
<!--        <div class="card" style="width: 18rem;">-->
<!--            <img src="{{ i.image_url }}" class="card-img-top" alt="...">-->
<!--            <div class="card-body">-->
<!--                <h5 class="card-title">{{ i.title }}</h5>-->
<!--                <p class="card-text">{{ i.price }}.</p>-->
<!--                <a href="#" class="btn btn-primary">Add</a>-->
<!--                <button class="btn btn-danger">-</button>-->
<!--                -->
<!--                <button class="btn btn-warning">+</button>-->
<!--            </div>-->
<!--        </div>-->
<!--        {% endfor %}-->
<!--    </div>-->

<!--<script src="https://telegram.org/js/telegram-web-app.js"></script>-->
<!--<script>-->
<!--    const tg = window.Telegram.WebApp;-->
<!--    const buyButton = document.getElementById("buy");-->
<!--    const orderForm = document.getElementById("form");-->
<!--    const main = document.getElementById("main");-->

<!--    buyButton.addEventListener("click", () => {-->
<!--        orderForm.style.display = "block"; // Show the form-->
<!--        main.style.display = "none";-->
<!--        tg.expand(); // Expand the Telegram Web App-->
<!--    });-->

<!--    orderForm.addEventListener("submit", function (event) {-->
<!--        event.preventDefault(); // Prevent default form submission-->

<!--        const userName = document.getElementById("user_name").value;-->
<!--        const userEmail = document.getElementById("user_email").value;-->
<!--        const userPhone = document.getElementById("user_phone").value;-->

<!--        // Format the message-->
<!--        const message = `New Order:\n\nName: ${userName}\nEmail: ${userEmail}\nPhone: ${userPhone}`;-->

<!--        // Use the Telegram Bot API to send the message-->
<!--        const botToken = '7525079654:AAFLaYwTC2niT3r7w3wDmFwvVc4kemWb7D0'; // Replace with your bot token-->

<!--        const chatId = '1368941825'; // Replace with your chat ID-->
<!--        const telegramUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;-->

<!--        fetch(telegramUrl, {-->
<!--            method: 'POST',-->
<!--            headers: {-->
<!--                'Content-Type': 'application/json',-->
<!--            },-->
<!--            body: JSON.stringify({-->
<!--                chat_id: chatId,-->
<!--                text: message,-->
<!--                parse_mode: "Markdown"-->
<!--            }),-->
<!--        })-->
<!--        .then(response => {-->
<!--            if (response.ok) {-->
<!--                // Optionally, handle success (reset form, show success message, etc.)-->
<!--                alert('Order sent successfully!');-->
<!--                orderForm.reset(); // Reset the form fields-->
<!--                orderForm.style.display = 'none'; // Hide the form again-->
<!--            } else {-->
<!--                alert('Error sending order. Please try again.');-->
<!--            }-->
<!--        })-->
<!--        .catch(error => {-->
<!--            console.error('Error:', error);-->
<!--            alert('Error sending order. Please try again.');-->
<!--        });-->
<!--    });-->
<!--</script>-->
<!--</body>-->
<!--</html>-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Shop</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
<nav class="navbar navbar-light mx-5">
    <p class="navbar-brand">Akaldo</p>
    <ul class="d-flex list-unstyled gap-3">
        <li>About us</li>
        <li>Contact</li>
        <li>Features</li>
        <li>Pricing</li>
    </ul>
</nav>

<div class="container d-flex gap-3 flex-wrap justify-content-center">
    {% for i in items %}
    <div class="card" style="width: 18rem;">
        <img src="{{ i.image_url }}" class="card-img-top" alt="...">
        <div class="card-body text-center">
            <h5 class="card-title">{{ i.title }}</h5>
            <p class="card-text">{{ i.price }}.</p>

            <!-- Add to Cart Button -->
            <button class="btn btn-primary add-to-cart" data-id="{{ i.id }}" data-title="{{ i.title }}"
                    data-price="{{ i.price }}">
                Add to Cart
            </button>

            <!-- Quantity Controls -->
            <div class="quantity-controls d-none" data-id="{{ i.id }}">
                <button class="btn btn-danger decrease">-</button>
                <span class="quantity">1</span>
                <button class="btn btn-warning increase">+</button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<button class="btn btn-success mt-3" id="checkout">Checkout</button>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!--<script>-->
<!--    const tg = window.Telegram.WebApp;-->
<!--    tg.expand();-->

<!--    const cart = {};-->

<!--    document.querySelectorAll(".add-to-cart").forEach(button => {-->
<!--        button.addEventListener("click", function () {-->
<!--            const itemId = this.dataset.id;-->
<!--            const itemTitle = this.dataset.title;-->
<!--            const itemPrice = this.dataset.price;-->

<!--            // Store item in cart-->
<!--            cart[itemId] = { title: itemTitle, price: itemPrice, quantity: 1 };-->

<!--            // Hide "Add to Cart" button and show quantity controls-->
<!--            this.classList.add("d-none");-->
<!--            const controls = document.querySelector(`.quantity-controls[data-id='${itemId}']`);-->
<!--            controls.classList.remove("d-none");-->
<!--        });-->
<!--    });-->

<!--    document.querySelectorAll(".increase").forEach(button => {-->
<!--        button.addEventListener("click", function () {-->
<!--            const itemId = this.parentElement.dataset.id;-->
<!--            cart[itemId].quantity++;-->
<!--            this.previousElementSibling.textContent = cart[itemId].quantity;-->
<!--        });-->
<!--    });-->

<!--    document.querySelectorAll(".decrease").forEach(button => {-->
<!--        button.addEventListener("click", function () {-->
<!--            const itemId = this.parentElement.dataset.id;-->
<!--            cart[itemId].quantity&#45;&#45;;-->

<!--            if (cart[itemId].quantity === 0) {-->
<!--                // Remove item from cart and reset UI-->
<!--                delete cart[itemId];-->
<!--                this.parentElement.classList.add("d-none");-->
<!--                document.querySelector(`.add-to-cart[data-id='${itemId}']`).classList.remove("d-none");-->
<!--            } else {-->
<!--                this.nextElementSibling.textContent = cart[itemId].quantity;-->
<!--            }-->
<!--        });-->
<!--    });-->

<!--    document.getElementById("checkout").addEventListener("click", function () {-->
<!--        if (Object.keys(cart).length === 0) {-->
<!--            alert("Your cart is empty!");-->
<!--            return;-->
<!--        }-->

<!--        // Format the order message-->
<!--        let message = "üõí New Order:\n";-->
<!--        Object.values(cart).forEach(item => {-->
<!--            message += `üìå ${item.title} - ${item.quantity} x ${item.price} USD\n`;-->
<!--        });-->

<!--        // Send to Telegram Bot-->
<!--        const botToken = '7525079654:AAFLaYwTC2niT3r7w3wDmFwvVc4kemWb7D0';  // Replace with your bot token-->
<!--        const chatId = '1368941825';  // Replace with your chat ID-->
<!--        const telegramUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;-->

<!--        fetch(telegramUrl, {-->
<!--            method: 'POST',-->
<!--            headers: { 'Content-Type': 'application/json' },-->
<!--            body: JSON.stringify({-->
<!--                chat_id: chatId,-->
<!--                text: message,-->
<!--                parse_mode: "Markdown"-->
<!--            }),-->
<!--        })-->
<!--        .then(response => {-->
<!--            if (response.ok) {-->
<!--                alert("Order sent to Telegram!");-->
<!--            } else {-->
<!--                alert("Failed to send order.");-->
<!--            }-->
<!--        });-->

<!--        // Send to Order API-->
<!--        fetch("http://127.0.0.1:8000/api/orders/", {-->
<!--            method: 'POST',-->
<!--            headers: { 'Content-Type': 'application/json' },-->
<!--            body: JSON.stringify(cart),-->
<!--        })-->
<!--        .then(response => {-->
<!--            if (response.ok) {-->
<!--                alert("Order sent to API!");-->
<!--            } else {-->
<!--                alert("Failed to send order to API.");-->
<!--            }-->
<!--        });-->

<!--    });-->
<!--</script>-->
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const cart = {};

    document.querySelectorAll(".add-to-cart").forEach(button => {
        button.addEventListener("click", function () {
            const itemId = this.dataset.id;
            const itemTitle = this.dataset.title;
            const itemPrice = this.dataset.price;

            if (!cart[itemId]) {
                cart[itemId] = { title: itemTitle, price: itemPrice, quantity: 1 };
            }

            this.classList.add("d-none");
            const controls = document.querySelector(`.quantity-controls[data-id='${itemId}']`);
            controls.classList.remove("d-none");
            controls.querySelector(".quantity").textContent = cart[itemId].quantity;
        });
    });

    document.querySelectorAll(".increase").forEach(button => {
        button.addEventListener("click", function () {
            const itemId = this.parentElement.dataset.id;
            cart[itemId].quantity++;
            this.previousElementSibling.textContent = cart[itemId].quantity;
        });
    });

    document.querySelectorAll(".decrease").forEach(button => {
        button.addEventListener("click", function () {
            const itemId = this.parentElement.dataset.id;
            cart[itemId].quantity--;

            if (cart[itemId].quantity === 0) {
                delete cart[itemId];
                this.parentElement.classList.add("d-none");
                document.querySelector(`.add-to-cart[data-id='${itemId}']`).classList.remove("d-none");
            } else {
                this.nextElementSibling.textContent = cart[itemId].quantity;
            }
        });
    });

    document.getElementById("checkout").addEventListener("click", function () {
        if (Object.keys(cart).length === 0) {
            alert("üõí Your cart is empty!");
            return;
        }

        let message = "üõí New Order:\n";
        Object.values(cart).forEach(item => {
            message += `üìå ${item.title} - ${item.quantity} x ${item.price} USD\n`;
        });

        const botToken = 'YOUR_BOT_TOKEN';

        // ‚úÖ Ensure chatId is fetched correctly
        const user = tg.initDataUnsafe.user;
        if (!user || !user.id) {
            alert("‚ö†Ô∏è Unable to retrieve Telegram ID. Please restart the app.");
            return;
        }
        const chatId = user.id;
        const telegramUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;

        // ‚úÖ Send Order to Telegram Bot
        fetch(telegramUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                text: message,
                parse_mode: "Markdown"
            }),
        })
        .then(response => response.ok ? alert("‚úÖ Order sent to Telegram!") : alert("‚ùå Failed to send order to Telegram."));

        // ‚úÖ Send Order to Django API
        fetch("http://127.0.0.1:8000/api/orders/create-order/", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                telegram_id: chatId,
                cart: cart
            }),
        })
        .then(response => response.ok ? alert("‚úÖ Order sent to API!") : alert("‚ùå Failed to send order to API."));

        // ‚úÖ Ask for Location after 3 seconds
        setTimeout(() => {
            const locationKeyboard = {
                keyboard: [[{ text: "üìç Send Location", request_location: true }]],
                resize_keyboard: true,
                one_time_keyboard: true
            };

            fetch(telegramUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: "üìç Please share your location for delivery.",
                    reply_markup: JSON.stringify(locationKeyboard)  // üîπ **Fixed! Must be JSON stringified**
                }),
            });
        }, 3000);
    });
</script>


</body>
</html>
